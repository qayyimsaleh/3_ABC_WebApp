@model ABC_WebApp.Models.AdminDashboardViewModel
@{
    ViewBag.Title = "Admin Dashboard";
}

@section Styles {
<style>
    .dash-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:28px; flex-wrap:wrap; gap:14px; }
    .dash-header h1 { font-size:28px; font-weight:600; }
    .dash-header p  { color:var(--text-light); margin-top:4px; }
    /* Stat Cards */
    .stats-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:20px; margin-bottom:28px; }
    .stat-card  { background:#fff; border-radius:var(--radius-lg); box-shadow:var(--shadow-md); padding:22px; border-top:4px solid var(--primary); }
    .stat-card.green { border-color:var(--success); }
    .stat-card.red   { border-color:var(--error); }
    .stat-card.blue  { border-color:var(--info); }
    .stat-head  { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
    .stat-icon  { width:44px; height:44px; border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:20px; }
    .stat-icon.p  { background:var(--primary-light); color:var(--primary); }
    .stat-icon.g  { background:rgba(40,167,69,.12); color:var(--success); }
    .stat-icon.r  { background:rgba(220,53,69,.12); color:var(--error); }
    .stat-icon.b  { background:rgba(23,162,184,.12); color:var(--info); }
    .stat-num   { font-size:32px; font-weight:700; }
    .stat-label { font-size:14px; color:var(--text-light); margin-bottom:10px; }
    /* Filter Bar */
    .filter-bar { background:#fff; border-radius:var(--radius-lg); box-shadow:var(--shadow-md); padding:20px; margin-bottom:24px; display:flex; gap:14px; flex-wrap:wrap; align-items:flex-end; }
    .filter-group { display:flex; flex-direction:column; gap:5px; flex:1; min-width:160px; }
    .filter-group label { font-size:13px; font-weight:500; }
    .filter-group select, .filter-group input { padding:9px 12px; border:1px solid var(--gray-300); border-radius:var(--radius); font-size:14px; }
    /* Table */
    .table-card { background:#fff; border-radius:var(--radius-lg); box-shadow:var(--shadow-md); overflow:hidden; }
    .table-toolbar { padding:18px 20px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--gray-200); flex-wrap:wrap; gap:12px; }
    .table-toolbar h3 { font-size:17px; font-weight:600; }
    .table-wrap { overflow-x:auto; }
    table { width:100%; border-collapse:collapse; font-size:14px; }
    thead th { background:var(--gray-100); padding:12px 14px; text-align:left; font-weight:600; border-bottom:2px solid var(--gray-200); white-space:nowrap; }
    tbody td { padding:11px 14px; border-bottom:1px solid var(--gray-200); }
    tbody tr:last-child td { border-bottom:none; }
    tbody tr:hover { background:var(--gray-100); }
    .emp-id { font-family:monospace; font-weight:600; color:var(--primary); }
    .dept-cell { max-width:180px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .status-badge { display:inline-flex; align-items:center; gap:5px; padding:4px 12px; border-radius:14px; font-size:12px; font-weight:600; }
    .s-pass { background:rgba(40,167,69,.12); color:var(--success); }
    .s-fail { background:rgba(220,53,69,.12); color:var(--error); }
    .ts-date { display:block; font-size:11px; color:var(--text-light); margin-top:3px; }
    .empty-state { text-align:center; padding:50px; color:var(--text-light); }
    .empty-state i { font-size:48px; margin-bottom:14px; display:block; opacity:.4; }
    @@media(max-width:768px){ .stats-grid{grid-template-columns:1fr 1fr;} }
    @@media(max-width:480px){ .stats-grid{grid-template-columns:1fr;} }
</style>
}

<div class="container-wide">

    <div class="dash-header fade-in">
        <div>
            <h1><i class="fas fa-chart-bar" style="color:var(--primary)"></i> Training Status Dashboard</h1>
            <p>ABC Training Analytics — @Model.CurrentYear &bull; Total active employees: @Model.TotalEmployees</p>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
            <button class="btn btn-success" onclick="exportExcel()"><i class="fas fa-file-excel"></i> Export Excel</button>
            <button class="btn btn-secondary" onclick="exportCSV()"><i class="fas fa-file-csv"></i> Export CSV</button>
            <a href="@Url.Action("Index","Home")" class="btn btn-outline"><i class="fas fa-arrow-left"></i> Back</a>
        </div>
    </div>

    <!-- Stat Cards -->
    <div class="stats-grid fade-in">
        <div class="stat-card">
            <div class="stat-head">
                <div>
                    <div class="stat-num">@Model.TotalEmployees</div>
                    <div class="stat-label">Total Employees</div>
                </div>
                <div class="stat-icon p"><i class="fas fa-users"></i></div>
            </div>
            <div class="progress-bar-wrap">
                <div class="progress-bar-fill" style="width:100%"></div>
            </div>
        </div>
        <div class="stat-card green">
            <div class="stat-head">
                <div>
                    <div class="stat-num" id="stat-p1-pass">@Model.PassedPart1</div>
                    <div class="stat-label">Passed Part 1 (@Model.CurrentYear)</div>
                </div>
                <div class="stat-icon g"><i class="fas fa-check-circle"></i></div>
            </div>
            <div class="progress-bar-wrap">
                <div class="progress-bar-fill" id="bar-p1" style="width:@(Model.TotalEmployees > 0 ? (Model.PassedPart1 * 100 / Model.TotalEmployees) : 0)%;background:var(--success)"></div>
            </div>
            <small class="stat-label" id="pct-p1">@(Model.TotalEmployees > 0 ? Math.Round((double)Model.PassedPart1 / Model.TotalEmployees * 100, 1) : 0)%</small>
        </div>
        <div class="stat-card green">
            <div class="stat-head">
                <div>
                    <div class="stat-num" id="stat-p2-pass">@Model.PassedPart2</div>
                    <div class="stat-label">Passed Part 2 (@Model.CurrentYear)</div>
                </div>
                <div class="stat-icon g"><i class="fas fa-award"></i></div>
            </div>
            <div class="progress-bar-wrap">
                <div class="progress-bar-fill" id="bar-p2" style="width:@(Model.TotalEmployees > 0 ? (Model.PassedPart2 * 100 / Model.TotalEmployees) : 0)%;background:var(--success)"></div>
            </div>
            <small class="stat-label" id="pct-p2">@(Model.TotalEmployees > 0 ? Math.Round((double)Model.PassedPart2 / Model.TotalEmployees * 100, 1) : 0)%</small>
        </div>
        <div class="stat-card red">
            <div class="stat-head">
                <div>
                    <div class="stat-num" id="stat-p1-fail">@Model.NotPassedPart1</div>
                    <div class="stat-label">Not Completed Part 1</div>
                </div>
                <div class="stat-icon r"><i class="fas fa-exclamation-circle"></i></div>
            </div>
        </div>
    </div>

    <!-- Filter Bar -->
    <div class="filter-bar fade-in">
        <div class="filter-group">
            <label>Search Name / ID</label>
            <input type="text" id="searchInput" placeholder="Search..." oninput="applyFilters()" />
        </div>
        <div class="filter-group">
            <label>Department</label>
            <select id="deptFilter" onchange="applyFilters()">
                <option value="">All Departments</option>
            </select>
        </div>
        <div class="filter-group">
            <label>Employee Type</label>
            <select id="typeFilter" onchange="applyFilters()">
                <option value="">All Types</option>
                <option value="1">Local</option>
                <option value="0">Foreign</option>
            </select>
        </div>
        <div class="filter-group">
            <label>Status</label>
            <select id="statusFilter" onchange="applyFilters()">
                <option value="">All</option>
                <option value="both-pass">Both Parts Passed</option>
                <option value="p1-pass">Part 1 Passed</option>
                <option value="p2-pass">Part 2 Passed</option>
                <option value="not-pass">Not Completed</option>
            </select>
        </div>
        <button class="btn btn-secondary" onclick="clearFilters()"><i class="fas fa-times"></i> Clear</button>
    </div>

    <!-- Data Table -->
    <div class="table-card fade-in">
        <div class="table-toolbar">
            <h3><i class="fas fa-table"></i> Employee Training Records</h3>
            <span id="rowCount" style="font-size:14px;color:var(--text-light);">Loading...</span>
        </div>
        <div class="table-wrap">
            <table id="mainTable">
                <thead>
                    <tr>
                        <th>Employee ID</th>
                        <th>Name</th>
                        <th>Department</th>
                        <th>Company</th>
                        <th>Part 1 Status</th>
                        <th>Part 2 Status</th>
                        <th>Type</th>
                        <th>Last Activity</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr><td colspan="8" class="empty-state"><span class="spinner spinner-dark"></span> Loading data...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

</div>

@section Scripts {
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<script>
    var allData      = [];
    var filteredData = [];
    var currentYear  = @Model.CurrentYear;

    // ── Load data from server ───────────────────────────────────────────────────
    fetch('@Url.Action("GetScoresJson","Admin")')
        .then(function(r){ return r.json(); })
        .then(function(d){
            allData      = d;
            filteredData = d;
            populateDeptFilter(d);
            applyFilters();
        })
        .catch(function(){
            document.getElementById('tableBody').innerHTML =
                '<tr><td colspan="8" class="empty-state"><i class="fas fa-exclamation-triangle"></i> Failed to load data.</td></tr>';
        });

    function populateDeptFilter(data) {
        var depts = [...new Set(data.map(function(e){ return e.Department; }))].sort();
        var sel   = document.getElementById('deptFilter');
        depts.forEach(function(d){
            var opt = document.createElement('option');
            opt.value = d; opt.textContent = d;
            sel.appendChild(opt);
        });
    }

    function applyFilters() {
        var search = document.getElementById('searchInput').value.toLowerCase();
        var dept   = document.getElementById('deptFilter').value;
        var type   = document.getElementById('typeFilter').value;
        var status = document.getElementById('statusFilter').value;

        filteredData = allData.filter(function(e){
            if (search && !(e.EmployeeID.toLowerCase().includes(search) || e.UserName.toLowerCase().includes(search))) return false;
            if (dept && e.Department !== dept) return false;
            if (type !== '' && e.Local !== type) return false;
            if (status === 'both-pass' && !(e.Part1==='pass' && e.Part2==='pass')) return false;
            if (status === 'p1-pass'   && e.Part1 !== 'pass') return false;
            if (status === 'p2-pass'   && e.Part2 !== 'pass') return false;
            if (status === 'not-pass'  && (e.Part1==='pass' || e.Part2==='pass')) return false;
            return true;
        });

        renderTable(filteredData);
        updateStats(filteredData);
    }

    function clearFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('deptFilter').value  = '';
        document.getElementById('typeFilter').value  = '';
        document.getElementById('statusFilter').value= '';
        applyFilters();
    }

    function updateStats(data) {
        var total = data.length;
        var p1    = data.filter(function(e){ return e.Part1 === 'pass'; }).length;
        var p2    = data.filter(function(e){ return e.Part2 === 'pass'; }).length;
        document.getElementById('stat-p1-pass').textContent = p1;
        document.getElementById('stat-p2-pass').textContent = p2;
        document.getElementById('stat-p1-fail').textContent = total - p1;
        document.getElementById('bar-p1').style.width = (total > 0 ? (p1/total*100).toFixed(1) : 0) + '%';
        document.getElementById('bar-p2').style.width = (total > 0 ? (p2/total*100).toFixed(1) : 0) + '%';
        document.getElementById('pct-p1').textContent = (total > 0 ? (p1/total*100).toFixed(1) : 0) + '%';
        document.getElementById('pct-p2').textContent = (total > 0 ? (p2/total*100).toFixed(1) : 0) + '%';
        document.getElementById('rowCount').textContent = 'Showing ' + total + ' of ' + allData.length + ' employees';
    }

    function renderTable(data) {
        var tbody = document.getElementById('tableBody');
        if (!data.length) {
            tbody.innerHTML = '<tr><td colspan="8"><div class="empty-state"><i class="fas fa-database"></i><p>No records match the current filters.</p></div></td></tr>';
            return;
        }

        var rows = data.map(function(e){
            var p1cls  = e.Part1 === 'pass' ? 's-pass' : 's-fail';
            var p2cls  = e.Part2 === 'pass' ? 's-pass' : 's-fail';
            var p1icon = e.Part1 === 'pass' ? 'check-circle' : 'times-circle';
            var p2icon = e.Part2 === 'pass' ? 'check-circle' : 'times-circle';
            var latest = latestDate(e.Part1Timestamp, e.Part2Timestamp);
            return '<tr>' +
                '<td class="emp-id">' + esc(e.EmployeeID) + '</td>' +
                '<td>' + esc(e.UserName) + '</td>' +
                '<td class="dept-cell" title="' + esc(e.Department) + '">' + esc(e.Department) + '</td>' +
                '<td>' + esc(e.CompanyID) + '</td>' +
                '<td><span class="status-badge ' + p1cls + '"><i class="fas fa-' + p1icon + '"></i>' + e.Part1 + '</span>' +
                    (e.Part1Timestamp ? '<span class="ts-date">' + fmtDate(e.Part1Timestamp) + '</span>' : '') + '</td>' +
                '<td><span class="status-badge ' + p2cls + '"><i class="fas fa-' + p2icon + '"></i>' + e.Part2 + '</span>' +
                    (e.Part2Timestamp ? '<span class="ts-date">' + fmtDate(e.Part2Timestamp) + '</span>' : '') + '</td>' +
                '<td>' + (e.Local === '1' ? 'Local' : 'Foreign') + '</td>' +
                '<td>' + (latest ? fmtDateTime(latest) : '<span style="color:var(--text-light);font-style:italic">None</span>') + '</td>' +
                '</tr>';
        });
        tbody.innerHTML = rows.join('');
    }

    function latestDate(d1, d2) {
        if (!d1 && !d2) return null;
        if (!d1) return d2;
        if (!d2) return d1;
        return new Date(d1) > new Date(d2) ? d1 : d2;
    }

    function fmtDate(s) {
        if (!s) return '';
        try { return new Date(s).toLocaleDateString('en-MY',{day:'2-digit',month:'2-digit',year:'numeric'}); } catch(e){ return s; }
    }

    function fmtDateTime(s) {
        if (!s) return '';
        try {
            return new Date(s).toLocaleDateString('en-MY',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit',hour12:false});
        } catch(e){ return s; }
    }

    function esc(s) {
        if (!s) return '';
        return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    // ── Export functions ────────────────────────────────────────────────────────
    function exportExcel() {
        if (!filteredData.length) { alert('No data to export.'); return; }

        var rows = filteredData.map(function(e){ return {
            'Employee ID'         : e.EmployeeID,
            'Name'                : e.UserName,
            'Department'          : e.Department,
            'Company ID'          : e.CompanyID,
            'Employee Type'       : e.Local === '1' ? 'Local' : 'Foreign',
            'Part 1 Status'       : e.Part1,
            'Part 1 Date'         : e.Part1Timestamp ? fmtDateTime(e.Part1Timestamp) : '',
            'Part 2 Status'       : e.Part2,
            'Part 2 Date'         : e.Part2Timestamp ? fmtDateTime(e.Part2Timestamp) : '',
            'Last Activity'       : latestDate(e.Part1Timestamp,e.Part2Timestamp) ? fmtDateTime(latestDate(e.Part1Timestamp,e.Part2Timestamp)) : ''
        }; });

        var wb  = XLSX.utils.book_new();
        var ws  = XLSX.utils.json_to_sheet(rows);
        XLSX.utils.book_append_sheet(wb, ws, 'Training Data');

        // Department summary sheet
        var deptMap = {};
        filteredData.forEach(function(e){
            if (!deptMap[e.Department]) deptMap[e.Department] = {total:0,p1:0,p2:0};
            deptMap[e.Department].total++;
            if (e.Part1==='pass') deptMap[e.Department].p1++;
            if (e.Part2==='pass') deptMap[e.Department].p2++;
        });
        var sumRows = [['Department','Total','Part 1 Passed','Part 1 %','Part 2 Passed','Part 2 %']];
        Object.keys(deptMap).sort().forEach(function(k){
            var d = deptMap[k];
            sumRows.push([k, d.total, d.p1, (d.p1/d.total*100).toFixed(1)+'%', d.p2, (d.p2/d.total*100).toFixed(1)+'%']);
        });
        var ws2 = XLSX.utils.aoa_to_sheet(sumRows);
        XLSX.utils.book_append_sheet(wb, ws2, 'Department Summary');

        var ts = new Date().toISOString().slice(0,10);
        XLSX.writeFile(wb, 'ABC_Training_Report_' + currentYear + '_' + ts + '.xlsx');
    }

    function exportCSV() {
        if (!filteredData.length) { alert('No data to export.'); return; }
        var headers = ['Employee ID','Name','Department','Company ID','Employee Type','Part 1 Status','Part 1 Date','Part 2 Status','Part 2 Date'];
        var csvRows = [headers.join(',')];
        filteredData.forEach(function(e){
            csvRows.push([
                e.EmployeeID, e.UserName, '"'+e.Department+'"', e.CompanyID,
                e.Local==='1'?'Local':'Foreign', e.Part1,
                e.Part1Timestamp ? fmtDateTime(e.Part1Timestamp) : '',
                e.Part2,
                e.Part2Timestamp ? fmtDateTime(e.Part2Timestamp) : ''
            ].join(','));
        });
        var blob = new Blob([csvRows.join('\n')], {type:'text/csv'});
        var a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'ABC_Training_' + currentYear + '.csv';
        a.click();
    }
</script>
}
